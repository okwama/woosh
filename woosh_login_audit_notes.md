# Woosh Login Audit & Troubleshooting Notes

## Audit Summary

### Login & Token Handling
- Login uses `ApiService.login()` and stores access/refresh tokens in `GetStorage` via `TokenService.storeTokens()`.
- Token expiration is set by the backend (default: 9 hours).
- On app start, `TokenService.isAuthenticated()` and `authController.isLoggedIn` determine if the user is sent to Home or Login.
- After login, all users are now redirected to `/home` (role check removed).

### Debounce
- Login button uses debounce (500ms) to prevent rapid multiple requests.

### Token Refresh
- Before API calls, token expiry is checked. If expired, the app tries to refresh using the refresh token.
- If refresh fails, tokens are cleared and the user is logged out.

### Logout Triggers
- Manual logout (user action)
- Token expiry + refresh failure
- Backend invalidates token (e.g., login elsewhere, admin action)
- Storage cleared (OS, app update, crash)

## Session Field Optimization

### Essential Fields Only
The app now uses only essential session fields to reduce complexity and improve performance:

**Required Fields:**
- `id` - Unique session identifier
- `userId` - User who owns the session
- `sessionStart` - Session start time (check-in)
- `sessionEnd` - Session end time (check-out)
- `duration` - Session duration in minutes
- `status` - Session status ("1" = active, "2" = ended)
- `loginAt` - Login timestamp
- `logoutAt` - Logout timestamp

**Optional Fields (Nullable):**
- `isLate` - Whether check-in was late
- `isEarly` - Whether check-out was early
- `timezone` - User's timezone
- `shiftStart` - Shift start time
- `shiftEnd` - Shift end time

### Benefits
- Reduced API payload size
- Simplified frontend logic
- Better performance
- Easier maintenance
- Backward compatibility maintained

## Troubleshooting Random Logouts

### Possible Causes
- Network/server issues causing 401 errors
- Refresh token expiry or backend revocation
- Multiple device logins
- Storage issues (GetStorage cleared)
- App bugs in token handling

### Diagnosis Steps
- Add debug logs to all logout/token-clear paths
- Log all 401 API responses
- Check for storage read/write failures
- Review backend logs for token blacklisting

## Recommendations
- Add persistent debug logging to catch the exact reason for logout
- Test on a single device to rule out multi-device issues
- Check with backend for token policies

---

*This file was generated by AI to summarize the login audit and troubleshooting steps. Update as needed as you continue development.* 